{
  "attributes": {
    "raw": {
      "document": "---\ntitle: \"Detecting and responding to Dirty Pipe with Elastic\"\nslug: \"detecting-and-responding-to-dirty-pipe-with-elastic\"\ndate: \"2022-09-09\"\ndescription: \"Elastic Security is releasing detection logic for the Dirty Pipe exploit.\"\nauthor:\n  - slug: colson-wilhoit\n  - slug: samir-bousseaden\n  - slug: jake-king\n  - slug: andrew-pease\nimage: \"photo-edited-01@2x.jpg\"\ncategory:\n  - slug: security-research\n---\n\n## Preamble\n\nDirty Pipe is a local privilege escalation vulnerability that is easily exploitable with a handful of working exploit POCs already available. Its broad scope (any user-readable file and affected Linux versions) along with its evolving nature (the SUID shell backdoor exploit) make CVE-2022-0847 especially dangerous for administrators of systems that are potentially vulnerable.\n\n### What is Dirty Pipe (CVE-2022-0847)?\n\n[CVE-2022-0847](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0847) is a Linux local privilege escalation vulnerability, discovered by security researcher Max Kellermann that takes advantage of the way the Linux kernel manages page files and named pipes allowing for the overwriting of data in read-only files. This vulnerability impacts Linux kernels 5.8 and later until any version before 5.16.11, 5.15.25, and 5.10.102.\n\n### What is the impact?\n\nWith many POC’s already released, this vulnerability can be easily exploited to gain root-level privileges by, for instance, rewriting sensitive files like “/etc/passwd” or hijacking a SUID root binary (like sudo) via injection of malicious code.\n\n### What is Elastic doing about it?\n\nElastic is releasing detection logic and Auditd rules that can be used to detect exploitation of this vulnerability.\n\n## Dirty Pipe Details\n\nThe vulnerability can be exploited due to a flaw in the new pipe buffer structure where a flag member lacked proper initialization and could then contain a stale value. This could then be used to write to pages within the page cache behind read-only files, allowing for privilege escalation. Given the specific nature of this vulnerability, detection can be quite difficult.\n\n### Linux Pipes & CVE-2022-0847\n\n[Pipes](https://man7.org/linux/man-pages/man2/pipe.2.html) are an interprocess communication mechanism represented as a file within Linux that can receive input data and provide an output for that data. The output of one process can become the input of another using a “pipe” to forward that data between.\n\nPipes are managed by the CPU in memory and their data is referred to as a “page”.\n\nThe exploitation of this vulnerability utilizes a process called “page splicing”. Page splicing is used to merge data between different pipe pages in memory without having to rewrite the data.\n\nThe flag we referenced in the summary is the PIPE_BUF_FLAG_CAN_MERGE flag. This must be set in order for a page cache to be merged and is only set when the pipe page becomes full. Howerver, if the page cache is emptied completely this flag remains (lack of initialization) which is where the problem lies.\n\nThe exploit functions generally by:\n\n1. Opening a new pipe\n2. Filling the pipe’s page cache with arbitrary data in order to set the PIPE_BUF_FLAG_CAN_MERGE flag\n3. Draining the page cache of data but retaining the PIPE_BUF_FLAG_CAN_MERGE flag and replacing the data with the new data they want to overwrite a read-only file with\n4. The splice (“page splicing”) [syscall](https://man7.org/linux/man-pages/man2/syscalls.2.html) is then used to merge the pages (the pipe page and target file page) leading to the new data being added to a target file bypassing the read-only permissions\n\nMany of the exploit POCs observed so far target the /etc/passwd file to overwrite and provide the users with elevated root privileges. Other variants of the exploit released allow for the creation of a SUID shell backdoor by overwriting a binary that has SUID permissions (superuser capabilities) giving the user a root shell and complete control.\n\nWe anticipate that adversaries and researchers will develop a multitude of other exploitation chains with this particular vulnerability.\n\n### Proof Of Concept Code\n\nThe security community has developed a multitude of different tests that adversaries may take advantage of in future attacks against systems. POCs listed below are authored to help security researchers identify if systems are impacted by the vulnerability, and furthermore - test detection strategies.\n\n- Original Max Kellermann write-up: [https://dirtypipe.cm4all.com/](https://dirtypipe.cm4all.com/)\n- SUID shell: ​​[https://haxx.in/files/dirtypipez.c](https://haxx.in/files/dirtypipez.c)\n- Passwd overwrite: [https://github.com/liamg/traitor](https://github.com/liamg/traitor)\n- Passwd overwrite: ​​[https://github.com/imfiver/CVE-2022-0847](https://github.com/imfiver/CVE-2022-0847)\n- Metasploit module: [https://github.com/rapid7/metasploit-framework/pull/16303](https://github.com/rapid7/metasploit-framework/pull/16303)\n\n## Finding systems vulnerable to Dirty Pipe\n\nBeyond using a traditional vulnerabilty scanner, there are several ways to detect systems vulnerable to Dirty Pipe.\n\n### Using the Elastic Security Integration\n\nIf you have Auditbeat, Filebeat (with the Auditd module enabled), or the Elastic Agent (with the Security or Auditd integrations deployed) you can use the Lens visualization tool (located in Kibana) to quickly compile and save a list of vulnerable systems as evidenced in the screenshot below:\n\n![Analyzing your infrastructure for kernel versions impacted by Dirty Pipe](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image7.png)\n\n### Using the Osquery Manager Integration\n\nAdditionally, you can use the [Osquery Manager integration](https://docs.elastic.co/en/integrations/osquery_manager) to collect the kernel information from all endpoints. To do this, you need to add the Osquery Manager integration to an Elastic Agent policy (Integrations → Osquery Manager → Add Osquery Manager). Once you’ve added the integration, you can perform a simple query: SELECT version FROM kernel_info; which will return the hostname and Linux kernel version from all endpoints with the policy.\n\n![Using Osquery Manager to collect kernel versions](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image3.jpg)\n\n## Detecting CVE-2022-0847 exploitation using Auditd\n\n[Auditd](https://linux.die.net/man/8/auditd) is the userspace component of the Linux Auditing System. Auditd stands for Audit Daemon and is a background running service responsible for collecting and writing log files to disk. The Linux Audit System includes a kernel component that hooks system calls and communicates those to Auditd. Auditd is capable of logging System Calls, File Access, and certain pre-configured Audit events. You can install and enable Auditd for free with the package manager on your Linux distribution of choice.\n\n### Auditd rules\n\nAuditd rules define what is to be captured and logged. These rules are generally defined in an audit.rules file and placed at /etc/audit/audit.rules or /etc/audit/rules.d/audit.rules. Events are written to /var/log/audit/audit.log on the local system.\n\nOnce you have installed and enabled Auditd, you can add the below lines to your audit.rules file to detect Dirty Pipe exploitation attempts.\n\n```\nDirty Pipe Auditd rules\n\n-a always,exit -F arch=b64 -S splice -F a0=0x3 -F a2=0x5 -F a3=0x0 -F key=dirtypipe\n-a always,exit -F arch=b64 -S splice -F a0=0x6 -F a2=0x8 -F a3=0x0 -F key=dirtypipe\n-a always,exit -F arch=b64 -S splice -F a0=0x7 -F a2=0x9 -F a3=0x0 -F key=dirtypipe\n```\n\n> The aforementioned rules were adapted by Elastic Security from initial findings by [Jonas LeJon](https://twitter.com/jonasl/status/1501840914381258756).\n\n## Linux Auditing System event collection with Elastic\n\nThere are a few different ways to collect Linux Auditing System events using Elastic. You can either use the Elastic Agent with the Auditd integration, Auditbeat, or the Auditd module for Filebeat.\n\n> Remember, if you’re using the Auditd integrations for the Elastic Agent or Filebeat, you’ll need to create the [Auditd rules described above](https://www.elastic.co/security-labs/detecting-and-responding-to-dirty-pipe-with-elastic#auditd-rules).\n\n### The Elastic Agent w/Auditd Integration\n\nThe Elastic Agent with the [Auditd Integration](https://docs.elastic.co/en/integrations/auditd) allows for the collection of Auditd rules. To collect these events, you need to add the Auditd integration to an Elastic Agent policy (Integrations → Auditd → Add Auditd).\n\n![Elastic Agent Auditd integration](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image6.png)\n\nOnce this integration is installed to an Elastic Agent policy and deployed to endpoints, you will see Auditd events populated in Kibana.\n\nYou can verify that you are receiving Auditd events in Kibana by using the Kibana query event.dataset : \"auditd.log\".\n\n### Auditbeat\n\nYou can use the [Auditbeat Auditd module](https://www.elastic.co/guide/en/beats/auditbeat/current/auditbeat-module-auditd.html) to collect the Linux Audit Framework logs. To do this, [install Auditbeat](https://www.elastic.co/guide/en/beats/auditbeat/current/auditbeat-installation-configuration.html). You might encounter errors if another process besides Auditbeat, such as Auditd, is registered to receive data from the Linux Audit Framework. To prevent this conflict, you can stop and disable Auditd from running.\n\n```\nStopping and disabling Auditd\n\nsudo service auditd.service stop\nsudo chkconfig auditd.service off\n```\n\nEdit the /etc/auditbeat/auditbeat.yml file to point to your local, remote, or cloud cluster and add the Dirty Pipe rules provided above in the Auditd rules section.\n\n```\nAdding Dirty Pipe detection rules to the Auditbeat configuration file\n\n# ===== Modules configuration =====\n\nauditbeat.modules:\n\n* module: auditd\n\n# Load audit rules from separate files. Same format as audit.rules(7)\n\n  audit_rule_files: [ '${path.config}/audit.rules.d/*.conf' ]\n  audit_rules: |\n\n## Define audit rules here\n\n## Create file watches (-w) or syscall audits (-a or -A). Uncomment these\n\n## examples or add your own rules\n\n    -a always,exit -F arch=b64 -S splice -F a0=0x3 -F a2=0x5 -F a3=0x0 -F key=dirtypipe\n    -a always,exit -F arch=b64 -S splice -F a0=0x6 -F a2=0x8 -F a3=0x0 -F key=dirtypipe\n    -a always,exit -F arch=b64 -S splice -F a0=0x7 -F a2=0x9 -F a3=0x0 -F key=dirtypipe\n\n…truncated…\n```\n\nCheck the configuration and connectivity of Auditbeat using the test commands.\n\n```\nTesting the Auditbeat configuration and output settings\n\nsudo auditbeat test config\nsudo auditbeat test output\n```\n\nRun the Auditbeat setup command using sudo auditbeat setup.\n\nStart Auditbeat using sudo systemctl start auditbeat.service.\n\nNow you should be able to verify events are being populated in the auditbeat-\\* Data View within Kibana.\n\n![Auditbeat Data View in Kibana](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image4.jpg)\n\n### Filebeat\n\nYou can use the [Auditd module for Filebeat](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-auditd.html) to collect the Auditd logs as well. To do this, [install Filebeat](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation-configuration.html) and then enable the Auditd module\n\nsudo filebeat modules enable auditd\n\nNext, go into the Auditd configuration file and enable log collection, test, setup, and then start Filebeat.\n\n```\nEnabling Auditd log in the Filebeat configuration file\n\nsudo vi /etc/filebeat/modules.d/auditd.yml\n\n# Module: auditd\n\n# Docs: <https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-module-auditd.html>\n\n* module: auditd\n  log:\n    enabled: true\n\n# Set custom paths for the log files. If left empty\n\n# Filebeat will choose the paths depending on your OS\n\n    #var.paths:\n\n```\n\n```\nTesting the Filebeat configuration and output settings\n\nsudo filebeat test config\nsudo filebeat test output\n```\n\nRun the Filebeat setup command using sudo filebeat setup.\n\nStart Filebeat using sudo systemctl start filebeat.service.\n\n## Detecting Dirty Pipe with Elastic\n\nNow that Linux Audit Framework events are being populated by either the Elastic Agent, Auditbeat, or Filebeat, you can run queries to detect exploitation attempts using the Kibana Query Language (KQL) in Discover or the Endpoint Query Language (EQL) in Kibana’s Security → Timelines → New Timeline → Correlation query editor.\n\n### Hunt queries in Kibana\n\nKQL query compatible with using the Elastic Agent, Auditbeat, or Filebeat:\n\n```\nKQL query to detect Dirty Pipe exploitation attempts\n\nauditd.log.key : dirtypipe and process.name : *\n\n```\n\nEQL query compatible with using the Auditbeat:\n\n```\nEQL query to detect Dirty Pipe exploitation attempts\n\nprocess where tags : \"dirtypipe\" and not process.name : \"\"\n```\n\n### Detection Engine alerts\n\nYou can also create a Detection Engine alert to monitor for exploitation attempts.\n\n![Dirty Pipe Detection Rule](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image2.jpg)\n\nExploitation attempts will be recorded in the Kibana Security Solution in the Alerts section.\n\n![A preview of alerts created pertaining to the log keys created by Auditd](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image5.png)\n\n## Respond to Observed Threats\n\nElastic makes it easy to quickly respond to a threat by isolating the host while still allowing it to communicate with your stack in order to continue monitoring actions taken and/or remediate the threat.\n\n![In-platform capabilities of Elastic Security demonstrating response capabilities](/assets/images/detecting-and-responding-to-dirty-pipe-with-elastic/dirty-pipe-with-elastic-image1.png)\n\n## Defense in Depth Recommendations\n\nThe following steps can be leveraged to improve a network’s protective posture:\n\n1. Review and ensure that you have deployed the latest stable and vendor-supplied kernel for your OS’\n2. Review and implement the above detection logic within your environment using technology described in the post\n3. Maintain backups of your critical systems to aid in quick recovery\n\n## References\n\nThe following research was referenced throughout the document:\n\n- Exploit CVE reference: [CVE-2022-0847](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0847)\n- Write-up using eBPF for some detections: [https://sysdig.com/blog/cve-2022-0847-dirty-pipe-sysdig](https://sysdig.com/blog/cve-2022-0847-dirty-pipe-sysdig/)\n- Original Max Kellermann write-up: [https://dirtypipe.cm4all.com/](https://dirtypipe.cm4all.com/)\n- SUID shell: ​​[https://haxx.in/files/dirtypipez.c](https://haxx.in/files/dirtypipez.c)\n- Passwd overwrite: [https://github.com/liamg/traitor](https://github.com/liamg/traitor)\n- Passwd overwrite: ​​[https://github.com/imfiver/CVE-2022-0847](https://github.com/imfiver/CVE-2022-0847)\n- Metasploit module: [https://github.com/rapid7/metasploit-framework/pull/16303](https://github.com/rapid7/metasploit-framework/pull/16303)\n- Original Auditd detection logic: [https://twitter.com/jonasl/status/1501840914381258756?s=20&t=MIWwwXpl5t0JiopVxX5M5Q](https://twitter.com/jonasl/status/1501840914381258756?s=20&t=MIWwwXpl5t0JiopVxX5M5Q)\n"
    },
    "title": "Detecting and responding to Dirty Pipe with Elastic",
    "slug": "detecting-and-responding-to-dirty-pipe-with-elastic",
    "date": "2022-09-09",
    "description": "Elastic Security is releasing detection logic for the Dirty Pipe exploit.",
    "author": [
      {
        "slug": "colson-wilhoit"
      },
      {
        "slug": "samir-bousseaden"
      },
      {
        "slug": "jake-king"
      },
      {
        "slug": "andrew-pease"
      }
    ],
    "image": "photo-edited-01@2x.jpg",
    "category": [
      {
        "slug": "security-research"
      }
    ]
  },
  "id": "security_labs_content-detecting_and_responding_to_dirty_pipe_with_elastic-md",
  "type": "security_labs_content"
}
