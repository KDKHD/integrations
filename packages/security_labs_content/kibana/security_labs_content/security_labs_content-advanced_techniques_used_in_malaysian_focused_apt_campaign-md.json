{
  "attributes": {
    "raw": {
      "document": "---\ntitle: \"A close look at the advanced techniques used in a Malaysian-focused APT campaign\"\nslug: \"advanced-techniques-used-in-malaysian-focused-apt-campaign\"\ndate: \"2022-06-22\"\ndescription: \"Our Elastic Security research team has focused on advanced techniques used in a Malaysian-focused APT campaign. Learn who’s behind it, how the attack works, observed MITRE attack® techniques, and indicators of compromise.\"\nauthor:\n  - slug: samir-bousseaden\n  - slug: daniel-stepanic\n  - slug: elastic-security-intelligence-analytics-team\nimage: \"blog-thumb-castle-tower.jpg\"\ncategory:\n  - slug: campaigns\n---\n\nThe Elastic Security Intelligence & Analytics Team researches adversary innovations of many kinds, and has recently focused on an activity group that leveraged remote templates, VBA code evasion, and DLL side-loading techniques. Based on code similarity and shared tactics, techniques, and procedures (TTPs), the team assessed this activity to be possibly linked to a Chinese-based group known as APT40, or Leviathan. The group’s campaign appears to target Malaysian government officials with a lure regarding the 2020 Malaysian political crisis.\n\n## Anatomy of the attack\n\n![Figure 1: Original image](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/1-leviathan-apt-blog-original-image.jpg)\n\n![Figure 2: Lure document image](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/2-leviathan-apt-blog-lure-document-image.jpg)\n\nTo initiate their advanced persistent threat (APT) campaign, the group likely delivered a Microsoft Word document as a phishing lure attachment. The image used in the lure (Figure 2) appears to be crafted from a broadcast announcement shared by a Malaysian blogger (Figure 1). The lure image includes the same broadcast time, but the date and speech topic are removed. Once this attachment is opened, a decoy document is presented while behind the scenes, taking the following actions:\n\n- The lure document downloads the remote template RemoteLoad.dotm\n- The remote template executes VBA macro code\n- The VBA macro code unpacks and executes two embedded base64-encoded DLLs (sl1.tmp and sl2.tmp) to c:\\users\\public\\\n\nThis technique is known as template injection, which you may recall from our [Playing defense against Gamaredon Group blog post](https://www.elastic.co/blog/playing-defense-against-gamaredon-group). This an effective approach used by adversaries to bypass perimeter controls such as email gateways.\n\n![Figure 4: Obfuscation of MZ/PE header base64](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/4-leviathan-apt-blog-obfuscation.jpg)\n\nBoth embedded DLLs (sl1.tmp and sl2.tmp) are similar and export the same function names: RCT and RCP. The first DLL (sl1.tmp) is used to download a benign executable called LogiMailApp.exe and an associated library LogiMail.dll, and the second DLL (sl2.tmp) is used to execute LogiMailApp.exe, which automatically attempts to execute LogiMail.dll due to an inherent DLL search order vulnerability we’ll cover shortly.\n\n|                 |           |              |                                  |                           |\n| --------------- | --------- | ------------ | -------------------------------- | ------------------------- |\n| File name       | File type | Size (bytes) | MD5                              | Compile time              |\n| LogiMailApp.exe | Win32 EXE | 311656       | 850a163ce1f9cff0367854038d8cfa7e | 2012-09-26 22:13:13+00:00 |\n| LogiMail.dll    | Win32 DLL | 105984       | b5a5dc78fb392fae927e9461888f354d | 2020-06-03 04:08:29+00:00 |\n| sl1.tmp         | Win32 DLL | 3072         | ccbdda7217ba439dfb6bbc6c3bd594f8 | 2019-11-29 17:15:29+00:00 |\n| sl2.tmp         | Win32 DLL | 3072         | dbfa006d64f39cde78b0efda1373309c | 2019-11-29 21:23:44+00:00 |\n\n_Table 1: Dropped files metadata_\n\n![Figure 5: Download and execution of LogiMailApp.exe and LogiMail.dll](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/5-leviathan-apt-blog-download-execution.jpg)\n\nThis implementation stood out to our researchers due to a behavioral idiosyncrasy:\n\n- The Microsoft Office application winword.exe loads sl1.tmp and sl2.tmp DLLs uses the LoadLibraryA method, which is moderately rare\n- These DLLs run explicit commands or install a payload from a URL using the CallWindowProcA method, which appears to be exceptionally rare\n- Both DLLs are deleted after execution\n\n![Figure 6: Download and execution module deletion](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/6-leviathan-apt-blog-module.jpg)\n\n## Embedded DLLs\n\nThe embedded DLLs, sl1.tmp and sl2.tmp, have very limited functionality — exporting the RCP and RCT functions. The RCP function implements the WinExec method to execute commands where the RCT function uses the URLDownloadToFileA method to download a file from a specified URL.\n\n![Figure 7: Exported functions – RCP and RCT](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/7-leviathan-apt-blog-exported-functions.jpg)\n\n## DLL side-loading a backdoor\n\nLogiMailApp.exe, which is downloaded by sl1.tmp and executed by sl2.tmp, is vulnerable to a form of DLL search-order hijacking called side-loading, which automatically searches for and executes LogiMail.dll if found in the same directory. Forms of DLL search-order hijacking can be used with many third-party software applications. In this case, search-order hijacking was used to load a backdoor that exports the following notable functions:\n\n![Figure 8: LogiMail.dll exports table](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/8-leviathan-apt-blog-logimail-exports.jpg)\n\n![Figure 9: LogiMailApp.exe – Logitech camera software](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/9-leviathan-apt-blog-logitech-software.jpg)\n\n![Figure 10: LogiMail.dll side-loading](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/10-leviathan-apt-blog-side-loading.jpg)\n\nThe adversary-created binary LogiMail.dll exports the function DllGetClassObject that contains critical logic for the execution flow of this sample:\n\n1. Download an AES-encrypted second stage object to %TEMP%\\~liseces1.pcs\n2. Derive a 128-bit AES key and initialization vector from SHA256 of a hardcoded string\n3. Read and decrypt %TEMP%\\~liseces1.pcs in memory using the ReadFile and CryptDecrypt functions\n4. Delete %TEMP%\\~liseces1.pcs from disk\n\n![Figure 11: Encrypted URL and hardcoded key](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/11-leviathan-apt-blog-encrypted-url.jpg)\n\n![Figure 12: Decrypted second stage URL and temp staging file](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/12-leviathan-apt-blog-decrypted-second-stage.jpg)\n\n![Figure 13: Second stage download, in-memory decryption, execution, and file deletion](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/13-leviathan-apt-blog-second-stage-download.jpg)\n\n## Second stage backdoor\n\nThe decrypted second stage backdoor is mapped into memory and then its original entry point (OEP) is called, thus bypassing successful detections based on file system scanning.\n\n![Figure 14: LogiMail.dll — Resolving needed functions to map second stage PE into memory](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/14-leviathan-apt-blog-resolving-needed-functions.jpg)\n\n![Figure 15: The second stage implant mapped in LogiMailApp.exe memory](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/15-leviathan-apt-blog-second-stage-mapped.jpg)\n\nBoth the payload staging server and the second stage infrastructure use dynamic DNS:\n\n![Figure 16: C2 HTTP POST request to /postlogin](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/16-leviathan-apt-blog-c2.jpg)\n\nThis payload supports the following capabilities:\n\n- Basic anti-debug checks\n- System and user discovery\n- Execution via command line\n- File discovery, upload, and download\n- Persistence via run registry\n- Encrypt C2 traffic using same AES key\n\n![Figure 17: System and user discovery](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/17-leviathan-apt-blog-system-discovery.jpg)\n\n![Figure 18: Execution via command-line](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/18-leviathan-apt-blog-execution-command-line.jpg)\n\n![Figure 19: File discovery, upload, and download](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/19-leviathan-apt-blog-file-discovery.jpg)\n\n## Possible APT40/Leviathan connection\n\nEarlier in the year, the Malaysian Computer Emergency Response Team (MyCERT) issued an [advisory](https://www.mycert.org.my/portal/advisory?id=MA-774.022020) related to espionage activity targeting their country. The report listed different TTPs and included multiple samples and other technical indicators that align with a threat group known as APT40/Leviathan.\n\nAt a high level, this sample follows the continued trend of targeting Malaysian victims using specific TTPs such as remote templates, employing macros, using DLL side-loading techniques, and leveraging an in-memory implant with dynamic DNS for command and control. More specifically, the second stage implant from this lure shares unique strings and URL references and contains similar functionality that correlates with the previous reporting for APT40/Leviathan. With these similarities, our Intelligence & Analytics Team assesses with moderate confidence that this activity is linked to APT40/Leviathan.\n\nImplant String Similarities with MyCERT Sample:\n\n- /list_direction\n- /post_document\n- /post_login\n- Open Remote File %s Failed For: %s\n- Open Pipe Failed %s\n- Download Read Path Failed %s\n- %02X-%02X-%02X-%02X-%02X-%02X\n- Software\\Microsoft\\Windows\\CurrentVersion\\Run\n- ntkd\n\n![](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/20-leviathan-apt-blog-shared-strings.jpg)\n\n![Figure 20: Shared strings with MyCERT sample - 8a133a382499e08811dceadcbe07](/assets/images/advanced-techniques-used-in-malaysian-focused-apt-campaign/21-leviathan-apt-blog-shared-strings-2.jpg)\n\n## Conclusion\n\nIn this post, we highlighted a recent sample that most likely represents the work of a highly organized adversary. Activity groups like this are significant for everyone to take notice of, if only because they represent a higher maturity level of post-exploit innovation. Their cutting edge TTPs today end up being everyone’s run of the mill tomorrow; it’s important to learn from these events.\n\nWe hope that by sharing some of these insights, we can help raise awareness and continue to focus on protecting the world's data from attack. To enable organizations further, we’ve added all the observed MITRE ATT&CK® techniques and indicators of compromise (IoCs) below.\n\n### MITRE ATT&CK® techniques\n\n- [T1193 - Spearphishing Attachment](https://attack.mitre.org/techniques/T1193/)\n- [T1221 - Template Injection](https://attack.mitre.org/techniques/T1221/)\n- [T1060 - Registry Run Keys / Startup Folder](https://attack.mitre.org/techniques/T1060/)\n- [T1073 - DLL Side-Loading](https://attack.mitre.org/techniques/T1073/)\n- [T1129 - Execution through Module Load](https://attack.mitre.org/techniques/T1129/)\n- [T1055 - Process Injection](https://attack.mitre.org/techniques/T1055/)\n- [T1107 - File Deletion](https://attack.mitre.org/techniques/T1107/)\n- [T1140 - Deobfuscate/Decode Files or Information](https://attack.mitre.org/techniques/T1140/)\n- [T1059 - Command-Line Interface](https://attack.mitre.org/techniques/T1059/)\n\n### Indicators of Compromise (IOCs)\n\n#### File names and paths\n\n```\nBubar Parlimen.zip\nBubar Parlimen.docx\nRemoteLoad.dotm\nC:\\Users\\Public\\sl1.tmp\nC:\\Users\\Public\\sl2.tmp\nC:\\Users\\*\\AppData\\Local\\Temp\\~liseces1.pcs\nC:\\Users\\*\\AppData\\Local\\Microsoft\\Office\\LogiMailApp.exe\nC:\\Users\\*\\AppData\\Local\\Microsoft\\Office\\LogiMail.dll\n```\n\n#### Registry keys\n\n```\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\ntkd\n```\n\n#### URLs\n\n```\nhxxps[:]//armybar[.]hopto[.]org/LogiMail.dll\nhxxps[:]//armybar[.]hopto[.]org/LogiMailApp[.]exe\nhxxps[:]//armybar[.]hopto[.]org/Encrypted\nhxxp[:]//tomema.myddns[.]me/postlogin\nhxxp[:]//tomema[.]myddns[.]me/list_direction\nhxxp[:]//tomema[.]myddns[.]me/post_document\n```\n\n#### IPs\n\n```\n104[.]248[.]148[.]156\n139[.]59[.]31[.]188\n```\n\n#### HTTPS certificate\n\n```\n74b5e317527c93539dbaaf84d6a61da92a56012a\n```\n\n#### Hashes\n\n```\n523cbdaf31ddc920e5b6c873f3ab42fb791fb4c9d1f4d9e6a7f174105d4f72a1\nab541df861c6045a17006969dac074a7d300c0a8edd0a5815c8b871b62ecdda7\n145daf50aefb7beec32556fd011e10c9eaa71e356649edfce4404409c1e8fa30\n93810c5fd9a287d85c182d2ad13e7d30f99df76e55bb40e5bc7a486d259810c8\n925f404b0207055f2a524d9825c48aa511199da95120ed7aafa52d3f7594b0c9\nfeca9ad5058bc8571d89c9d5a1eebce09e709cc82954f8dce1564e8cc6750a77\n06a4246be400ad0347e71b3c4ecd607edda59fbf873791d3772ce001f580c1d3\n77ef350639b767ce0a748f94f723a6a88609c67be485b9d8ff8401729b8003d2\n```\n\n### YARA\n\n```\nrule APT_APT40_Implant_June2020 {\n   meta:\n       version = \"1.0\"\n       author =  \"Elastic Security\"\n       date_added = \"2020-06-19\"\n       description = \"APT40 second stage implant\"\n    strings:\n        $a = \"/list_direction\" fullword wide\n        $b = \"/post_document\" fullword wide\n        $c = \"/postlogin\" fullword wide\n        $d = \"Download Read Path Failed %s\" fullword ascii\n        $e = \"Open Pipe Failed %s\" fullword ascii\n        $f = \"Open Remote File %s Failed For: %s\" fullword ascii\n        $g = \"Download Read Path Failed %s\" fullword ascii\n        $h = \"\\\\cmd.exe\" fullword wide\n    condition:\n        all of them\n}\n```\n\n### References\n\n- [https://www.mycert.org.my/portal/advisory?id=MA-774.022020](https://www.mycert.org.my/portal/advisory?id=MA-774.022020)\n\n- [https://prezi.com/view/jGyAzyy5dTOkDrtwsJi5/](https://prezi.com/view/jGyAzyy5dTOkDrtwsJi5/)\n- [https://www.fireeye.com/blog/threat-research/2019/03/apt40-examining-a-china-nexus-espionage-actor.html](https://www.fireeye.com/blog/threat-research/2019/03/apt40-examining-a-china-nexus-espionage-actor.html)\n- [https://malpedia.caad.fkie.fraunhofer.de/details/win.dadstache](https://malpedia.caad.fkie.fraunhofer.de/details/win.dadstache)\n"
    },
    "title": "A close look at the advanced techniques used in a Malaysian-focused APT campaign",
    "slug": "advanced-techniques-used-in-malaysian-focused-apt-campaign",
    "date": "2022-06-22",
    "description": "Our Elastic Security research team has focused on advanced techniques used in a Malaysian-focused APT campaign. Learn who’s behind it, how the attack works, observed MITRE attack® techniques, and indicators of compromise.",
    "author": [
      {
        "slug": "samir-bousseaden"
      },
      {
        "slug": "daniel-stepanic"
      },
      {
        "slug": "elastic-security-intelligence-analytics-team"
      }
    ],
    "image": "blog-thumb-castle-tower.jpg",
    "category": [
      {
        "slug": "campaigns"
      }
    ]
  },
  "id": "security_labs_content-advanced_techniques_used_in_malaysian_focused_apt_campaign-md",
  "type": "security_labs_content"
}
