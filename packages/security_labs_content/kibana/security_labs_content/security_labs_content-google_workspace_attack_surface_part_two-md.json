{
  "attributes": {
    "raw": {
      "document": "---\ntitle: \"Google Workspace Attack Surface\"\nslug: \"google-workspace-attack-surface-part-two\"\ndate: \"2023-01-03\"\nsubtitle: \"Part Two: Setup Threat Detection With Elastic\"\ndescription: \"During part two of this multipart series, we’ll help you understand how to setup a GW lab for threat detection and research.\"\nauthor:\n  - slug: terrance-dejesus\nimage: \"photo-edited-01-e.jpg\"\ncategory:\ntags:\n  - threat detection\n  - cloud security\n  - google workspace\n  - google cloud\n---\n\n# Preamble\n\nAs a continuation of this series about Google Workspace’s (GW) attack surface, we diverge from surveying the land and focus on setting up a threat detection lab with Elastic. In [part one](https://www.elastic.co/security-labs/google-workspace-attack-surface-part-one), we explored the important resources and capabilities of GW, while tracking intrusion techniques that adversaries may leverage. In part two, we will give you the foundation needed to begin researching threats targeting GW, and provide resources for detecting those threats using Elastic technologies. The information used during the steps provided should be adjusted for your own lab and testing environment. If you do not feel the need to set up your own lab, that’s fine as this includes examples showing you how we detect threats to GW.\n\nFollowing this will be part three of this series, in which we cover common intrusion techniques by emulating the GW environment and simulating threat activity. In doing so, we’ll build detection logic to further detect several common techniques.\n\nElastic resources will be freely available but a registered domain for GW is necessary and will be covered in the upcoming steps, strictly for maximum authenticity. Approximate lab setup time is 20-30 minutes.\n\n## Let’s Get You Up to Speed\n\nFor those who may not be familiar with Elastic’s current stack: take a few minutes to review the current [solutions](https://www.elastic.co/blog/category/solutions) it offers. In short, the stack is an all-encompassing product that can be deployed anywhere from a single interface! If you would like to explore more information about the Elastic security solution, the [documentation](https://www.elastic.co/guide/en/security/current/getting-started.html) is a great starting point.\n\nIn this article, we will focus specifically on the security solution which includes a robust detection engine and 600+ pre-built threat [detection rules,](https://github.com/elastic/detection-rules/tree/main/rules) an endpoint agent that can be deployed to Windows, Linux, or macOS endpoints and collect data from various on-premise and cloud environments, as well as detect and prevent threats in real-time. Not to mention, this endpoint behavior logic is also all public in our [protections artifacts](https://github.com/elastic/protections-artifacts) repository.\n\nOur endpoint agent orchestrator, [Fleet](https://www.elastic.co/guide/en/fleet/current/fleet-overview.html), is manageable from the Kibana interface in the Elastic Stack. Fleet allows us to set up and deploy security policies to our endpoint agents. These policies are extremely customizable, thanks to an extensive list of supported [Integrations](https://www.elastic.co/integrations/).\n\nThink of an Integration as a module for the Elastic Agent that provides processors to collect specific data. When added to our security policy, an Integration allows the Elastic Agent to ingest logs, apply our Elastic Common Schema (ECS), and store them in the Elastic Stack for searching or to trigger alerts. If you're curious about a specific integration Elastic has, you can search for it [here](https://www.elastic.co/integrations/data-integrations)!\n\nWith this information you could almost assume the Elastic Stack allows you to manage all of this with just one information technology (IT) guy.\n\n![](/assets/images/google-workspace-attack-surface-part-two/ned.jpeg)\n\nEither way, our goal is to create a threat detection lab for [Google Workspace](https://docs.elastic.co/en/integrations/google_workspace) as depicted in this diagram:\n\n![Simple architecture layout and process workflow](/assets/images/google-workspace-attack-surface-part-two/image14.png)\n\nThe process of setting this up is pretty straightforward. Note that your environment does not have to be cloud-focused; if you prefer to do everything locally, you are more than welcome to. The [Elastic Container Project](https://www.elastic.co/security-labs/the-elastic-container-project) is a great resource for a local Docker build of the stack.\n\n## Sign-Up for Google Workspace\n\nIn order for you to use GW, you must have a registered Google account email address and organization. If you already have a GW setup for an organization, login to the [admin console](https://admin.google.com/) and continue to Create a Project in Google Cloud. This process will not go into detail about creating a Google account.\n\nOnce created, do the following:\n\n1. Visit [https://workspace.google.com](https://workspace.google.com) \\> Get Started\n2. Fill out the information requested in subsequent steps\n3. Business name: DeJesus’ Archeology\n4. Number of employees: 2-9\n5. Region: United States\n\nFor this lab, we will use DeJesus’ Archeology as a business name because it's memorable (also who didn't want to be an archeologist growing up?). We'll be digging up more recent evidence in these logs than we would from the earth, of course.\n\nEventually you will be asked, “Does your business have a domain?”. GW requires you to have your own domain name to use its services, especially the admin console for an organization. For today, we will select “No, I need one” and will use dejesusarcheology.com, but please select or use your own. From here, you will need to enter additional business information to register your domain and organization.\n\nYou will need a username to sign into your GW account and create your business email address. We'll use [terrance@dejesusarcheology.com](mailto:terrance@dejesusarcheology.com) as the administrative email. When finished, continue to login to your GW admin console with your new email where you should be greeted by a similar interface below.\n\n![Default page for GW admin console after login](/assets/images/google-workspace-attack-surface-part-two/image25.jpg)\n\n## Setup Google Cloud Platform (GCP)\n\nFor the Elastic agent to ingest GW logs, it relies solely on making requests to the [Reports API](https://developers.google.com/admin-sdk/reports/reference/rest) and therefore, we need to leverage GCP for a managed service account. This service account’s credentials will be used by our Elastic agent to then leverage the admin SDK API for pulling logs from GW’s Reports API into the Elastic Stack. Domain-wide delegation and OAuth2 are important for authentication and resource access but will be enabled through steps later on.\n\n### Create a Project\n\nGCP is hierarchical, so we must first create a project. If you already have a GCP environment setup, we recommend creating a new project that links to your GW via the registered domain by following similar steps below.\n\nComplete the following steps:\n\n1. Log into [Google Cloud](https://console.cloud.google.com/)with the same Google account used to setup GW\n2. Select the following: Select a project \\> New Project\n3. Enter the following information described in subsequent steps\n4. Project name: dejesus-archeology\n5. Organization: dejesusarcheology.com\n6. Location: dejesusarcheology.com\n\nWhen done, you should have a new organization and project in GCP. By default, only the creator of the project has rights to manage the project.\n\n![Project dashboard in Google Cloud](/assets/images/google-workspace-attack-surface-part-two/image19.jpg)\n\n### Enable Admin SDK API\n\nOur Elastic agent will eventually use our GCP service account, which uses the [Workspace Admin SDK](https://developers.google.com/admin-sdk) to interact with the GW admin console REST API, therefore it needs to be enabled in GCP. To keep your mind at ease, we will only be enabling read access to the Reports API for this admin SDK.\n\nComplete the following steps:\n\n- Select the Google Cloud navigation menu \\> APIs & Services \\> Enabled APIs & Services\n- Search and enable “Admin SDK API” from the API library page\n\nWhen finished, you will have enabled the Admin SDK API within your project, where your service account will have access to pull data from GW.\n\n![Admin SDK API enabled in GCP](/assets/images/google-workspace-attack-surface-part-two/image23.jpg)\n\n### Configure OAuth Consent Screen\n\nWe next need to set up the [OAuth consent screen](https://developers.google.com/workspace/guides/configure-oauth-consent) for our service account and application when they create API requests to GW, as it will include the necessary authorization token.\n\nComplete the following steps:\n\n1. Select the Google Cloud navigation menu \\> APIs & Services \\> Enabled APIs & Services \\> OAuth Consent Screen\n2. User Type \\> Internal \\> Create\n3. Fill out the following information in subsequent steps\n4. App name: elastic-agent\n5. User support email: [terrance@dejesusarcheology.com](mailto:terrance@dejesusarcheology.com)\n6. Authorized domains: dejesusarcheology.com\n7. Developer contact information: [terrance@dejesusarcheology.com](mailto:terrance@dejesusarcheology.com)\n8. Save and Continue\n9. Save and Continue\n10. Back to Dashboard\n\n![OAuth consent screen setup for application in GCP](/assets/images/google-workspace-attack-surface-part-two/image7.jpg)\n\nWhen finished, we will now have a registered application using OAuth 2.0 for authorization and the consent screen information set. Please note, the default token request limit for this app daily is 10,000 but can be increased. We recommend setting your Elastic agent’s pull rate to every 10 minutes which should not come close to this reaching this threshold. Setting the agent’s pull rate will be done at a later step.\n\n### Create a Service Account\n\nFor the Elastic agent to ingest data from GW, we will need to create a [service account](https://cloud.google.com/iam/docs/service-accounts) for the agent to use. This account is meant for non-human applications, allowing it to access resources in GW via the Admin SDK API we enabled earlier.\n\nTo create a service account, do the following:\n\n1. Select the navigation menu in Google Cloud \\> APIs & Services \\> Credentials \\> Create Credentials \\> Service Account\n2. Enter the following information:\n3. Service account name: elastic-agent\n4. Service account ID: elastic-agent\n5. Leave the rest blank and continue\n6. Select your new Service Account \\> Keys \\> Add Key \\> Create New Key \\> JSON\n\nBy default, the Owner role will be applied to this service account based on inheritance from the project, feel free to scope permissions tighter as best seen fit. When finished, you should have a service account named elastic-agent, credentials for this service account in a JSON file saved to your host. We will enter this information during our Fleet policy integration setup.\n\n![Service account creation in GCP](/assets/images/google-workspace-attack-surface-part-two/image8.jpg)\n\n### Enable Domain-Wide Delegation\n\nOur service account will need [domain-wide delegation](https://developers.google.com/admin-sdk/directory/v1/guides/delegation) of permissions to access APIs that reach outside of GCP and into GW. The important data necessary for this has already been established in earlier steps where we need an API key, service account and OAuth client ID.\n\nTo enable domain-wide delegation for your service account, do the following:\n\n1. In your GW Admin Console select \\> Navigation Menu \\> Security \\> Access and data control \\> API controls\n2. Select Manage Domain Wide Delegation \\> Add New\n3. Client ID: OAuth ID from Service Account in GCP\n4. Google Cloud Console \\> IAM & Admin \\> Service Accounts \\> OAuth 2 Client ID (copy to clipboard)\n5. OAuth Scopes: [https://www.googleapis.com/auth/admin.reports.audit.readonly](https://www.googleapis.com/auth/admin.reports.audit.readonly)\n\n![Domain-wide Delegation enabled in Google Workspace](/assets/images/google-workspace-attack-surface-part-two/image4.jpg)\n\nOur service account in GCP only needs access to admin.reports.audit.readonly to access GW [Audit Reports](https://developers.google.com/admin-sdk/reports/v1/get-start/overview) where these are converted into ECS documents for our Elastic Stack.\n\nIf you made it this far, CONGRATULATIONS you are doing outstanding! Your GW and GCP environments are now set up and finished. At this point you are almost done, we just need to set up the Elastic Stack.\n\n## Setting Up Your Free Cloud Stack\n\nFor this lab, we will use a [free trial](https://cloud.elastic.co/registration)of cloud elastic with your preference of a Google or Microsoft email account. You also have the option to create the stack in [Amazon Web Services](https://www.elastic.co/partners/aws?utm_campaign=Comp-Stack-Trials-AWSElasticsearch-AMER-NA-Exact&utm_content=Elasticsearch-AWS&utm_source=adwords-s&utm_medium=paid&device=c&utm_term=amazon%20elk&gclid=Cj0KCQiA1ZGcBhCoARIsAGQ0kkqI9gFWLvEX--Fq9eE8WMb43C9DsMg_lRI5ov_3DL4vg3Q4ViUKg-saAsgxEALw_wcB) (AWS), [GCP](https://www.elastic.co/guide/en/cloud/current/ec-billing-gcp.html) or [Microsoft Azure](https://www.elastic.co/partners/microsoft-azure) if you’d like to stand up your stack in an existing Cloud Service Provider (CSP). The free trial will deploy the stack to GCP.\n\nOnce registered for the free trial, we can focus on configuring the Elastic Stack deployment. For this lab, we will call our deployment gw-threat-detection and deploy it in GCP. It is fine to leave the default settings for your deployment and we recommend the latest version for all the latest features. For the purposes of this demo, we use the following:\n\n- Name: gw-threat-detection\n- Cloud provider: Google Cloud\n- Region: Iowa (us-central1)\n- Hardware profile: Storage optimized\n- Version: 8.4.1 (latest)\n\nOnce set, select “Create deployment” and the Elastic Stack will automatically be deployed in GCP where your deployment credentials will be displayed. You can download these credentials as a CSV file or save them wherever you best see fit, but they are crucial to logging into your deployed stack. The deployment takes approximately ~5 minutes to complete and once finished you can select “continue” to login. Congratulations, you have successfully deployed the Elastic Stack within minutes!\n\n![Default page after logging into deployed Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image9.jpg)\n\n## Setup Fleet from the Security Solution\n\nAs a reminder, [Fleet](https://www.elastic.co/guide/en/fleet/current/fleet-overview.html) enables the creation of a security policy, which can incorporate the [GW integration](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html)on an elastic-agent, in order to access and ingest GW logs into our stack.\n\n### Create a Google Workspace Policy\n\nIn order for our Elastic Agent to know which integration it is using, what data to gather and where to stream that data within our stack, we must first set up a custom Fleet policy, named Google Workspace.\n\nTo setup a fleet policy within your Elastic Stack, do the following in your Elastic Stack:\n\n- Navigation menu \\> Management \\> Fleet \\> Agent Policies \\> Create agent policy\n- Enter “Google Workspace” as a name \\> Create Agent Policy\n\n![Fleet agent policies page in Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image6.jpg)\n\n### Install the Elastic agent on an Endpoint\n\nAs previously mentioned, we have to install at least one agent on an endpoint to access data in GW, and will be subject to the deployed GW policy. We recommend a lightweight Linux host, either as a VM locally or in a CSP such as GCP to keep everything in the same environment. I will be using a VM instance of [Ubuntu 20.04 LTS](https://releases.ubuntu.com/focal/) VM in Google’s Compute Engine (GCE) of the same GCP project we have been working on. Your endpoint can be lightweight, such as GCP N1 or E2 series, as its sole purpose is to run the Elastic agent.\n\nAfter your endpoint is setup, do the following in your Elastic Stack to deploy your the agent:\n\n1. Navigation menu \\> Management \\> Fleet \\> Agents \\> Add Agent\n2. Ensure the GW policy is selected\n3. Select the appropriate OS\n4. Select the clipboard icon to copy the commands\n5. Run the commands on your endpoint to install the agent\n6. Once finished, Fleet should show a checkmark and state 1 agent has been enrolled and Incoming data confirmed\n\n![Installed Elastic agent on Linux endpoint and Fleet status page in Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image24.png)\n\n### Assign Google Workspace Integration to Fleet Policy\n\nWe must add the GW integration to our GW policy in order for it to collect data from GW and stream it to our Elastic Stack. We will configure the GW integration settings to have information created when we set up our GW environment to avoid having [unsecured credentials](https://attack.mitre.org/techniques/T1552/) on our Ubuntu host.\n\n⚠️ The GW integration has a default interval of 2 hours, meaning the Elastic agent will retrieve data every 2 hours due to potential [data retention and lag times](https://support.google.com/a/answer/7061566?hl=en). This should be adjusted in the integration itself and is accounted for in the following steps within your Elastic Stack:\n\n1. Navigation menu \\> Fleet \\> Agent Policies \\> Google Workspace \\> Add Integration\n2. Search for “Google Workspace” \\> Select Google Workspace\n3. Select “Add Google Workspace”\n4. Enter the following information for this integration:\n5. Integration name: google workspace\n6. Jwt File: Copy contents of JSON file from service account creation steps\n7. Delegated Account: [terrance@dejesusarcheology.com](mailto:terrance@dejesusarcheology.com) (Use your own)\n8. Interval: 10m\n9. Agent policy: Google Workspace\n10. Select “Save and Continue”\n11. Select “Save and deploy changes”\n\nOnce completed, your GW integration should be assigned to your GW policy with one agent assigned this policy.\n\n![Google Workspace integration enabled in Fleet policy in Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image18.jpg)\n\nTo recap on our Elastic Stack setup so far we have completed the following:\n\n- Deployed an Elastic Stack\n- Created a Fleet policy\n- Setup a lightweight Linux endpoint\n- Deployed an Elastic agent to the Linux endpoint\n- Enabled the Google Workspace integration inside our Fleet policy\n\n### Assign Google Workspace Integration to Fleet Policy\n\nRather than rely on the detection engineering (DE) higher powers, let’s take a second to actually confirm GW data is being ingested into our stack as expected at this point. We can rely on the Discovery feature of the Elastic Stack which allows us to search specific criteria across existing ECS documents. For this, we will use the filter criteria `data_stream.dataset : \"google_workspace.*\"` to look for any ECS documents that originate from a Google Workspace datastream.\n\n![Search results for Google Workspace ECS documents in Elastic Stack via Discover](/assets/images/google-workspace-attack-surface-part-two/image1.png)\n\nIf you do not have any results, generate some activity within your GW such as creating new users, enabling email routes, creating new Organizational Units (OU) and so forth, then refresh this query after the 10 minute window has surpassed.\n\n![](/assets/images/google-workspace-attack-surface-part-two/image5.gif)\n\nIf results are found, congratulations are in order because you now have a fully functional threat detection lab for Google Workspace with the Elastic Security for SIEM!\n\n## Enable Google Workspace Detection Rules\n\nAs stated earlier, Elastic has 600+ pre-built detection [rules](https://github.com/elastic/detection-rules/tree/main/rules/integrations/google_workspace) not only for Windows, Linux and MacOS endpoints, as well as several integrations including GW. You can view our current existing GW rules and MITRE ATT&CK [coverage](https://mitre-attack.github.io/attack-navigator/#layerURL=https%3A%2F%2Fgist.githubusercontent.com%2Fbrokensound77%2F1a3f65224822a30a8228a8ed20289a89%2Fraw%2FElastic-detection-rules-indexes-logs-google_workspaceWILDCARD.json&leave_site_dialog=false&tabs=false).\n\nTo enable GW rules, complete the following in the Elastic Stack:\n\n1. Navigation menu \\> Security \\> Manage \\> Rules\n2. Select “Load Elastic prebuilt rules and timeline templates”\n3. Once all rules are loaded:\n4. Select “Tags” dropdown\n5. Search “Google Workspace”\n6. Select all rules \\> Build actions dropdown \\> Enable\n\n![Enabled pre-built detection rules where tag is Google Workspace in Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image21.png)\n\nWhile we won’t go in-depth about exploring all rule information, we recommend doing so. Elastic has some additional information such as related integrations, investigation guides and more! Also, you can contribute back to the community by [creating your own detection rule](https://www.elastic.co/guide/en/security/current/rules-ui-create.html) with the “Create new rule” button, and [contribute](https://github.com/elastic/detection-rules#how-to-contribute) to our detection rules repository.\n\n## Let’s Trigger a Pre-Built Rule\n\nFor this example, we will provoke the [Google Workspace Custom Admin Role Created](https://github.com/elastic/detection-rules/blob/main/rules/integrations/google_workspace/persistence_google_workspace_custom_admin_role_created.toml) detection rule. In our GW admin console, visit Account \\> Admin roles and create a new role with the following information:\n\n1. Name: Curator\n2. Description: Your Choice\n3. Admin console privileges:\n4. Alert Center: Full Access\n\n![Create an admin role in Google Workspace admin console](/assets/images/google-workspace-attack-surface-part-two/image16.jpg)\n\nNow, we aren’t entirely sure why the Curator role would have access to our Alert Center, but the role seems either improperly scoped or someone wants to have the ability to potentially silence some alerts before our security team can investigate them. While the creation of administrative accounts ([T1136.003](https://attack.mitre.org/techniques/T1136/003/)) is not unusual, they should always be investigated if unexpected to ensure cloud roles ([T1098.003](https://attack.mitre.org/techniques/T1098/003/)) are properly scoped.\n\nTo view our detection alert, in your Elastic Stack, visit Navigation Menu \\> Security \\> Alerts and the following should show your alerts. From this, we can see that our rule triggered as well as [Google Workspace API Access Granted via Domain-Wide Delegation of Authority](https://github.com/elastic/detection-rules/blob/main/rules/integrations/google_workspace/persistence_google_workspace_api_access_granted_via_domain_wide_delegation_of_authority.toml).\n\n![Elastic Stack security alerts page displaying triggered alerts](/assets/images/google-workspace-attack-surface-part-two/image26.jpg)\n\nIf we select “View details” from the actions column, we receive a pop-out panel showing the alert overview, tabled data fields and values from our ECS document, as well as the raw JSON.\n\n![ECS document with tabled data view from Elastic Stack security alerts](/assets/images/google-workspace-attack-surface-part-two/image3.png)\n\nMost detection rules for GW can be developed with a few consistent fields such as those we describe in our [documentation](https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html), making new rules easier to create. If you would like to view all data fields for GW that the ECS schema contains, you can find that information [here](https://www.elastic.co/guide/en/beats/filebeat/current/exported-fields-google_workspace.html).\n\n## Let’s Trigger a Custom Rule\n\nWhile pre-built detection rules are great for having threat coverage during onboarding, maybe you would like to search your data and create a new custom rule tailored to your environment.\n\nSince the Elastic Stack is bundled with additional searching capabilities, we can rely on the Analytics [Discover](https://www.elastic.co/guide/en/kibana/current/discover.html) feature to start searching through our raw data for GW related documents by visiting Navigation Menu \\> Analytics \\> Discover.\n\nFrom here, we can change our data view to logs-\\* and then do an open-ended KQL query for `event.dataset: google_workspace*` which will return all documents where the source is from GW. You can then either start tabling the data based on available fields or view details about each document.\n\n![Google Workspace ECS documents search in Discover in Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image2.png)\n\nThis is important to understand because it influences rule development. Rules are often prototyped as a data reduction exercise, beginning very broad and being refined over time into an effective rule. If you are having difficulty after this exercise with creating detection logic, our [philosophy](https://github.com/elastic/detection-rules/blob/main/PHILOSOPHY.md) on doing so may be of assistance.\n\nFirst, we will add a user, Ray Arnold, to our organization who has administrative access. With our Ray Arnold account, we will generate some suspicious events in GW, such as creating a custom email route for Gmail that forwards email destined to our primary administrator (Terrance), to Ray Arnold. In this scenario we are focused on potential collection of sensitive information via email collection via an email forwarding rule ([T1114.003](https://attack.mitre.org/techniques/T1114/003/))\n\nComplete the following steps:\n\n1. Add Ray Arnold as a user:\n2. Navigate to the users settings in GW\n3. Select “add new user”\n4. First name: Ray\n5. Last name: Arnold\n6. Select “ADD NEW USER”\n7. Add Engineers group and make Ray Arnold the owner:\n8. Navigate to groups settings in GW\n\nYou can configure the following settings like these examples:\n\n1. Group name: Engineers\n2. Group email: [engineering@dejesusarcheology.com](mailto:engineering@dejesusarcheology.com)\n3. Group Description: Engineering group at dinosaur park who are responsible for technology and feeding velociraptors.\n4. Group owners: [ray@dejesusarcheology.com](mailto:ray@dejesusarcheology.com)\n5. Labels: Mailing and Security\n6. Who can join the group: Only invited users\n7. Select “Create Group”\n\nNow we assign admin roles and privileges to Ray Arnold: 1. Navigate to Ray Arnold’s user account 2. Select “Admin roles and privileges” \\> Assign Roles 3. Super Admin -\\> Assigned 4. Groups Admin -\\> Assigned 5. Services Admin -\\> Assigned 6. Select “Save”\n\n![Ray Arnold user created in Google Workspace with admin privileges](/assets/images/google-workspace-attack-surface-part-two/image12.jpg)\n\nIf done correctly, Ray Arnold should be a new user in GW for the DeJesus’ Archeology organization. He is also the owner of the Engineers group and has Super Admin, Groups Admin and Services Admin roles assigned to his account. Following this, we need to login to the GW admin console with Ray Arnold’s account and add a custom email route.\n\nThis provides our organization with an insider threat scenario. Ray Arnold was hired as an employee with authorization and authentication to GW admin console settings. Our organization trusts that Ray Arnold will receive compensation for the requirements agreed to during the hiring process. Risk-mitigation is then up to the administrator when scoping the proper permissions and roles applied to Ray Arnold.\n\n![Simple overview of insider threat via email collection by forwarding rule in Google Workspace](/assets/images/google-workspace-attack-surface-part-two/image13.png)\n\nComplete the following:\n\n1. Login to the admin console with Ray Arnold’s account\n2. Select Navigation Menu \\> Apps \\> Google Workspace \\> Gmail \\> Routing\n3. Select Configure for “Routing”\n4. Enter the following information\n5. Description: Default administrator spam filtering\n6. Email messages to affect: Inbound, Outbound, Internal - Sending, Internal - Receiving\n7. Also deliver to: [ray@dejesusarcheology.com](mailto:ray@dejesusarcheology.com)\n8. Account types to affect: Users\n9. Envelope filter: Only affect specific envelope recipients (Email address: [terrance@dejesusarcheology.com](mailto:terrance@dejesusarcheology.com))\n\nNow we can test our custom email route by sending [terrance@dejesusarcheology.com](mailto:terrance@dejesusarcheology.com) an email from a separate email (We created a random email account with Proton), that is private and discusses private details about new Paleo-DNA. Once you send an email, you can view Ray Arnold’s Gmail and see that this private email was additionally routed to [ray@dejesusarcheology.com](mailto:ray@dejesusarcheology.com), where we now have an existing insider threat potentially selling private information about our Paleo-DNA tests to competitors. This we cannot allow!\n\n![](/assets/images/google-workspace-attack-surface-part-two/image11.gif)\n\n### Identify a Potential Detection Rule for Custom Gmail Routes\n\nLuckily, we have the Elastic Stack on our side to help us thwart this potential insider threat by detecting custom Gmail route creations! Within your Elastic Stack, visit Navigation Menu \\> Analytics \\> Discover and let’s start creating our KQL query. Below are the query filters we should be looking for and the final query.\n\nKQL query:`event.dataset: google_workspace.admin and event.action: \"CREATE_GMAIL_SETTING\" and not related.user: terrance and google_workspace.admin.setting.name: (MESSAGE_SECURITY_RULE or EMAIL_ROUTE)`\n\nLet’s break this down further to explain what we are looking for:\n\n`event.dataset: google_workspace.admin` - Documents in ECS where the data sourced from GW, specifically admin reporting. Since a user needs to be an administrator, we should expect data to source from admin reporting, which may also indicate a compromised admin account or abuse of an admin not setup with principle of least-privilege (PoLP).\n\n`event.action: \"CREATE_GMAIL_SETTING\"` - The creation of a Gmail setting which is typically done by administrators.\n\n`not related.user: terrance` - So far, any creation of a Gmail setting by an administrator whose username is not “terrance” who is the only administrator that is expected to be touching such settings.\n\n`google_workspace.admin.setting.name: (MESSAGE_SECURITY_RULE or EMAIL_ROUTE)` - This setting name is specific to Gmail routing rules.\n\nPlugging this query into Discover, we have matching documents for this activity being reported in GW!\n\n![Custom query search in Elastic Stack Discover for email forwarding rule creation](/assets/images/google-workspace-attack-surface-part-two/image10.png)\n\n### Create a Custom Rule in the Security Feature\n\nLet’s wrap this up by adding our custom detection rule for this!\n\nTo add your custom rule, complete the following:\n\n1. In your Elastic Stack, select Navigation menu \\> Security \\> Manage \\> Rules\n2. Select “Create new rule”\n3. Enter the following information:\n4. Define rule: Source, Index Patterns: logs-google_workspace\\*\n5. Custom query: Our custom query\n\nAnd we define rule metadata:\n\n1. Name: Google Workspace Custom Forwarding Email Route Created\n2. Description: Your choice\n3. Default severity: High\n4. Tags: Google Workspace\n\nWhat is fantastic about this custom rule is we can send a notification via our platform of choice so we are notified immediately when this alert is triggered.\n\n![Security alert action for custom rule](/assets/images/google-workspace-attack-surface-part-two/image17.jpg)\n\nThen select “Create & enable rule” at the bottom to create your custom rule. If we replay the steps above to create a custom Gmail forwarding rule, we will now see an alert and receive a notification about the alert trigger!\n\n![Security alert for new custom detection rule in Elastic Stack](/assets/images/google-workspace-attack-surface-part-two/image15.png)\n\nAt this point, we are now aware that Ray Arnold has created a custom Gmail route rule in GW with no authorization. From our alert in the Elastic Stack and notification to the CEO, we can now take action to mitigate further risk.\n\n## Takeaways\n\nAs demonstrated, Elastic’s security solution and the Elastic Stack allow us to ingest GW reporting logs and scan this data with pre-built detection rules or custom rules. Combine this with other features of the stack such as [Enterprise Search](https://www.elastic.co/enterprise-search), [Observability](https://www.elastic.co/observability), and a very simple cloud stack deployment process and we can start detecting threats in our GW environment in no time.\n\nIt’s been quite a journey and you have accomplished an incredible amount of work. In part three of this series: Detecting Common Threats, we will emulate some common Google Workspace abuse by threat actors and create more advanced detection logic for these. Hold on tight, because it's about to get WILD.\n\nAlso, there is still so much more to explore within the Elastic Stack, as you have probably already found during this lab, so feel free to explore! Elastic continues to take action on security transparency as [recently](https://www.elastic.co/blog/continued-leadership-in-open-and-transparent-security) discussed.\n\nHopefully this provides you with a better understanding of the powerful capabilities within the Elastic Stack and how to use it to detect potential threats in GW. Thanks for reading/following along and may we all be in the capable hands of detection engineers in part three.\n"
    },
    "title": "Google Workspace Attack Surface",
    "slug": "google-workspace-attack-surface-part-two",
    "subtitle": "Part Two: Setup Threat Detection With Elastic",
    "date": "2023-01-03",
    "description": "During part two of this multipart series, we’ll help you understand how to setup a GW lab for threat detection and research.",
    "author": [
      {
        "slug": "terrance-dejesus"
      }
    ],
    "image": "photo-edited-01-e.jpg",
    "category": null,
    "tags": [
      "threat detection",
      "cloud security",
      "google workspace",
      "google cloud"
    ]
  },
  "id": "security_labs_content-google_workspace_attack_surface_part_two-md",
  "type": "security_labs_content"
}
