{
  "attributes": {
    "raw": {
      "document": "---\ntitle: \"GrimResource - Microsoft Management Console for initial access and evasion\"\nslug: \"grimresource\"\ndate: \"2024-06-22\"\nsubtitle: \"Adversaries adapting to Microsoft's new security landscape\"\ndescription: \"Elastic researchers uncovered a new technique, GrimResource, which allows full code execution via specially crafted MSC files. It underscores a trend of well-resourced attackers favoring innovative initial access methods to evade defenses.\"\nauthor:\n  - slug: joe-desimone\n  - slug: samir-bousseaden\nimage: \"grimresource.jpg\"\ncategory:\n  - slug: attack-pattern\ntags:\n  - grimresource\n  - mcc\n  - msc\n---\n\n## Overview\n\nAfter Microsoft [disabled](https://learn.microsoft.com/en-us/deployoffice/security/internet-macros-blocked) office macros by default for internet-sourced documents, other infection vectors like JavaScript, MSI files, LNK objects, and ISOs have surged in popularity. However, these other techniques are scrutinized by defenders and have a high likelihood of detection. Mature attackers seek to leverage new and undisclosed infection vectors to gain access while evading defenses. A [recent example](https://www.genians.co.kr/blog/threat_intelligence/facebook) involved DPRK actors using a new command execution technique in MSC files.\n\nElastic researchers have uncovered a new infection technique also leveraging MSC files, which we refer to as GrimResource. It allows attackers to gain full code execution in the context of `mmc.exe` after a user clicks on a specially crafted MSC file. A [sample](https://www.virustotal.com/gui/file/14bcb7196143fd2b800385e9b32cfacd837007b0face71a73b546b53310258bb) leveraging GrimResource was first uploaded to VirusTotal on June 6th.\n\n## Key takeaways\n\n* Elastic Security researchers uncovered a novel, in-the-wild code execution technique leveraging specially crafted MSC files referred to as GrimResource\n* GrimResource allows attackers to execute arbitrary code in Microsoft Management Console (`mmc.exe`) with minimal security warnings, ideal for gaining initial access and evading defenses\n* Elastic is providing analysis of the technique and detection guidance so the community can protect themselves \n\n## Analysis\n\nThe key to the [GrimResource](https://gist.github.com/joe-desimone/2b0bbee382c9bdfcac53f2349a379fa4) technique is using an old [XSS flaw](https://medium.com/@knownsec404team/from-http-domain-to-res-domain-xss-by-using-ie-adobes-pdf-activex-plugin-ba4f082c8199) present in the `apds.dll` library. By adding a reference to the vulnerable APDS resource in the appropriate StringTable section of a crafted MSC file, attackers can execute arbitrary javascript in the context of `mmc.exe`. Attackers can combine this technique with [DotNetToJScript](https://github.com/tyranid/DotNetToJScript/tree/master) to gain arbitrary code execution.\n\n![Reference to apds.dll redirect in StringTable](/assets/images/grimresource/image17.png \"Reference to apds.dll redirect in StringTable\")\n\nAt the time of writing, the sample identified in the wild had 0 static detections in [VirusTotal](https://www.virustotal.com/gui/file/14bcb7196143fd2b800385e9b32cfacd837007b0face71a73b546b53310258bb/details).\n\n![VirusTotal results](/assets/images/grimresource/image1.png \"VirusTotal results\")\n\nThe sample begins with a transformNode obfuscation technique, which was observed in recent but unrelated [macro samples](https://twitter.com/decalage2/status/1773114380013461799). This aids in evading ActiveX security warnings.\n\n![transformNode evasion and obfuscation technique](/assets/images/grimresource/image15.png \"transformNode evasion and obfuscation technique\")\n\nThis leads to an obfuscated embedded VBScript, as reconstructed below:\n\n![Obfuscated VBScript](/assets/images/grimresource/image8.png \"Obfuscated VBScript\")\n\nThe VBScript sets the target payload in a series of environment variables and then leverages the [DotNetToJs](https://github.com/tyranid/DotNetToJScript/blob/master/DotNetToJScript/Resources/vbs_template.txt) technique to execute an embedded .NET loader. We named this component PASTALOADER and may release additional analysis on this specific tool in the future.\n\n![Setting the target payload environment variables](/assets/images/grimresource/image13.png \"Setting the target payload environment variables\")\n\n![DotNetToJs loading technique](/assets/images/grimresource/image2.png \"DotNetToJs loading technique\")\n\nPASTALOADER retrieves the payload from environment variables set by the VBScript in the previous step:\n\n![PASTALOADER loader retrieving the payload](/assets/images/grimresource/image14.png \"PASTALOADER loader retrieving the payload\")\n\nFinally, PASTALOADER spawns a new instance of `dllhost.exe` and injects the payload into it. This is done in a deliberately stealthy manner using the [DirtyCLR](https://github.com/ipSlav/DirtyCLR/tree/7b1280fee780413d43adbad9f4c2a9ce7ed9f29e) technique, function unhooking, and indirect syscalls. In this sample, the final payload is Cobalt Strike.\n\n![Payload injected into dllhost.exe](/assets/images/grimresource/image7.png \"Payload injected into dllhost.exe\")\n\n## Detections\n\nIn this section, we will examine current behavior detections for this sample and present new, more precise ones aimed at the technique primitives.\n\n### Suspicious Execution via Microsoft Common Console\n\nThis detection was established prior to our discovery of this new execution technique. It was originally designed to identify a [different method](https://www.genians.co.kr/blog/threat_intelligence/facebook) (which requires the user to click on the Taskpad after opening the MSC file) that exploits the same MSC file type to execute commands through the Console Taskpads command line attribute:\n\n![Command task MSC sample](/assets/images/grimresource/image12.png \"Command task MSC sample\")\n\n```\nprocess where event.action == \"start\" and\n process.parent.executable : \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and  process.parent.args : \"*.msc\" and\n not process.parent.args : (\"?:\\\\Windows\\\\System32\\\\*.msc\", \"?:\\\\Windows\\\\SysWOW64\\\\*.msc\", \"?:\\\\Program files\\\\*.msc\", \"?:\\\\Program Files (x86)\\\\*.msc\") and\n not process.executable :\n              (\"?:\\\\Windows\\\\System32\\\\mmc.exe\",\n               \"?:\\\\Windows\\\\System32\\\\wermgr.exe\",\n               \"?:\\\\Windows\\\\System32\\\\WerFault.exe\",\n               \"?:\\\\Windows\\\\SysWOW64\\\\mmc.exe\",\n               \"?:\\\\Program Files\\\\*.exe\",\n               \"?:\\\\Program Files (x86)\\\\*.exe\",\n               \"?:\\\\Windows\\\\System32\\\\spool\\\\drivers\\\\x64\\\\3\\\\*.EXE\",\n               \"?:\\\\Program Files (x86)\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe\")\n```\nIt triggers here because this sample opted to spawn and inject a sacrificial instance of dllhost.exe:\n\n![GrimResource detected](/assets/images/grimresource/image10.png \"GrimResource detected\")\n\n### .NET COM object created in non-standard Windows Script Interpreter\n\nThe sample is using the [DotNetToJScript](https://github.com/tyranid/DotNetToJScript) technique, which triggers another detection looking for RWX memory allocation from .NET on behalf of a Windows Script Host (WSH) script engine (Jscript or Vbscript):\n\nThe following EQL rule will detect execution via the .NET loader:\n\n```\napi where\n  not process.name : (\"cscript.exe\", \"wscript.exe\") and\n  process.code_signature.trusted == true and\n  process.code_signature.subject_name : \"Microsoft*\" and\n  process.Ext.api.name == \"VirtualAlloc\" and\n  process.Ext.api.parameters.allocation_type == \"RESERVE\" and \n  process.Ext.api.parameters.protection == \"RWX\" and\n  process.thread.Ext.call_stack_summary : (\n    /* .NET is allocating executable memory on behalf of a WSH script engine\n     * Note - this covers both .NET 2 and .NET 4 framework variants */\n    \"*|mscoree.dll|combase.dll|jscript.dll|*\",\n    \"*|mscoree.dll|combase.dll|vbscript.dll|*\",\n    \"*|mscoree.dll|combase.dll|jscript9.dll|*\",\n    \"*|mscoree.dll|combase.dll|chakra.dll|*\"\n)\n```\n\nThe following alert shows `mmc.exe` allocating RWX memory and the `process.thread.Ext.call_stack_summary `captures the origin of the allocation from `vbscript.dll` to `clr.dll` : \n\n![mmc.exe allocating RWX memory](/assets/images/grimresource/image6.png \"mmc.exe allocating RWX memory\")\n\n### Script Execution via MMC Console File \n\nThe two previous detections were triggered by specific implementation choices to weaponize the GrimResource method (DotNetToJS and spawning a child process). These detections can be bypassed by using more OPSEC-safe alternatives.\n\nOther behaviors that might initially seem suspicious — such as `mmc.exe` loading `jscript.dll`, `vbscript.dll`, and `msxml3.dll` — can be clarified compared to benign data. We can see that, except for `vbscript.dll`, these WSH engines are typically loaded by `mmc.exe`: \n\n![Normal library load behaviors by mmc.exe](/assets/images/grimresource/image4.png \"Normal library load behaviors by mmc.exe\")\n\nThe core aspect of this method involves using [apds.dll](https://strontic.github.io/xcyclopedia/library/apds.dll-DF461ADCCD541185313F9439313D1EE1.html) to execute Jscript via XSS. This behavior is evident in the mmc.exe Procmon output as a `CreateFile` operation (`apds.dll` is not loaded as a library):\n\n![apds.dll being invoked in the MSC StringTable](/assets/images/grimresource/image9.png \"apds.dll being invoked in the MSC StringTable\")\n\n![Example of the successful execution of GrimResource](/assets/images/grimresource/image16.png \"Example of the successful execution of GrimResource\")\n\nWe added the following detection using Elastic Defend file open events where the target file is `apds.dll` and the `process.name` is `mmc.exe`: \n\nThe following EQL rule will detect the execution of a script from the MMC console:\n\n```\nsequence by process.entity_id with maxspan=1m\n [process where event.action == \"start\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and process.args : \"*.msc\"]\n [file where event.action == \"open\" and file.path : \"?:\\\\Windows\\\\System32\\\\apds.dll\"]\n```\n\n![Timeline showing the script execution with the MMC console](/assets/images/grimresource/image5.png \"Timeline showing the script execution with the MMC console\")\n\n### Windows Script Execution via MMC Console File\n\nAnother detection and forensic artifact is the creation of a temporary HTML file in the INetCache folder, named `redirect[*] `as a result of the APDS [XSS](https://owasp.org/www-community/attacks/xss/) redirection:\n\n![Contents of redirect.html](/assets/images/grimresource/image11.png \"Contents of redirect.html\")\n\nThe following EQL correlation can be used to detect this behavior while also capturing the msc file path: \n\n```\nsequence by process.entity_id with maxspan=1m\n [process where event.action == \"start\" and\n  process.executable : \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and process.args : \"*.msc\"]\n [file where event.action in (\"creation\", \"overwrite\") and\n  process.executable :  \"?:\\\\Windows\\\\System32\\\\mmc.exe\" and file.name : \"redirect[?]\" and \n  file.path : \"?:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Microsoft\\\\Windows\\\\INetCache\\\\IE\\\\*\\\\redirect[?]\"]\n```\n\n![Timeline detecting redirect.html](/assets/images/grimresource/image3.png \"Timeline detecting redirect.html\")\n\nAlongside the provided behavior rules, the following YARA rule can be used to detect similar files:\n\n```\nrule Windows_GrimResource_MMC {\n    meta:\n        author = \"Elastic Security\"\n        reference = \"https://www.elastic.co/security-labs/GrimResource\"\n        reference_sample = \"14bcb7196143fd2b800385e9b32cfacd837007b0face71a73b546b53310258bb\"\n        arch_context = \"x86\"\n        scan_context = \"file, memory\"\n        license = \"Elastic License v2\"\n        os = \"windows\"\n    strings:\n        $xml = \"<?xml\"\n        $a = \"MMC_ConsoleFile\" \n        $b1 = \"apds.dll\" \n        $b2 = \"res://\"\n        $b3 = \"javascript:eval(\"\n        $b4 = \".loadXML(\"\n    condition:\n       $xml at 0 and $a and 2 of ($b*)\n}\n```\n\n## Conclusion\n\nAttackers have developed a new technique to execute arbitrary code in Microsoft Management Console using crafted MSC files. Elastic’s existing out of the box coverage shows our defense-in-depth approach is effective even against novel threats like this. Defenders should leverage our detection guidance to protect themselves and their customers from this technique before it proliferates into commodity threat groups. \n\n## Observables\n\nAll observables are also [available for download](https://github.com/elastic/labs-releases/tree/main/indicators/grimresource) in both ECS and STIX formats.\n\nThe following observables were discussed in this research.\n\n| Observable                                                       | Type    | Name             | Reference             |\n|------------------------------------------------------------------|---------|------------------|-----------------------|\n| `14bcb7196143fd2b800385e9b32cfacd837007b0face71a73b546b53310258bb` | SHA-256 | `sccm-updater.msc` | Abused MSC file       |\n| `4cb575bc114d39f8f1e66d6e7c453987639289a28cd83a7d802744cd99087fd7` | SHA-256 | N/A              | PASTALOADER           |\n| `c1bba723f79282dceed4b8c40123c72a5dfcf4e3ff7dd48db8cb6c8772b60b88` | SHA-256 | N/A              | Cobalt Strike payload |\n"
    },
    "title": "GrimResource - Microsoft Management Console for initial access and evasion",
    "slug": "grimresource",
    "subtitle": "Adversaries adapting to Microsoft's new security landscape",
    "date": "2024-06-22",
    "description": "Elastic researchers uncovered a new technique, GrimResource, which allows full code execution via specially crafted MSC files. It underscores a trend of well-resourced attackers favoring innovative initial access methods to evade defenses.",
    "author": [
      {
        "slug": "joe-desimone"
      },
      {
        "slug": "samir-bousseaden"
      }
    ],
    "image": "grimresource.jpg",
    "category": [
      {
        "slug": "attack-pattern"
      }
    ],
    "tags": [
      "grimresource",
      "mcc",
      "msc"
    ]
  },
  "id": "security_labs_content-grimresource-md",
  "type": "security_labs_content"
}
